#!/bin/bash

# Creating a private and secure encrypted directory

myuser='abz'

# [EncFS] filesystem
{  
  
  # Install
  p encfs

  # Create the encrypted folder [Locked - Open]
  encfs ~/.Private ~/Private

  # Mount
  encfs -o nonempty  ~/.Private ~/Private
  
}

# [eCryptfs] filesystem
{
  
  # Install
  p ecryptfs-utils
  
  # Load
  sudo modprobe ecryptfs
  
  # Create the desired directories
  sudo mkdir -m 700 /home/$myuser/.Private
  sudo mkdir -m 500 /home/$myuser/Private
  sudo chown $myuser:$myuser /home/$myuser/{.Private,Private}
 
   
  # Start configuration process
  sudo ecryptfs-setup-private
  
  
  # eCryptfs can now be mounted on top of ~/Private.
  sudo mount -t ecryptfs /home/$myuser/.Private /home/$myuser/Private
  
  
  # To Mount with default options preselected
  sudo mount -t ecryptfs /home/$myuser/.Private /home/$myuser/Private \
  -o key=passphrase,ecryptfs_cipher=aes,ecryptfs_key_bytes=32,\
  ecryptfs_passthrough=n,ecryptfs_enable_filename_crypto=yes,\
  ecryptfs_fnek_sig=XXXXXXXX
  
  
  # To Mount through [fstab]
  /home/$myuser/.Private /home/$myuser/Private ecryptfs noauto,user,ecryptfs_sig=XXXXXXXX,ecryptfs_cipher=aes,ecryptfs_key_bytes=32,ecryptfs_fnek_sig=XXXXXXXX,ecryptfs_unlink_sigs 0 0
  
 # Additional option 
 passphrase_passwd_file=/tmp/key
 
 # /tmp/key should contain 
 passphrase_passwd=mypassword

}

# [LUKS] full disk encryption
{
  
# NOTE 1: The HDD partition to be encrypted will be wiped

# NOTE 2: If using LUKS with LVM, refer to LVM T&T

  
  # Wipe the disk (best practice)
  {
  
  sudo dd if=/dev/zero of=/dev/<(disk-to-be-encrypted)>
  
  }
  
  # Partition the HDD normally , /root <sda5> - /boot <sda6> - /home <sda7> - etc.
  {
   
  cfdisk /dev/xxx
  
  }
  
  # Start the encryption process
  {
  
  cryptsetup luksFormat /dev/sda5
  
  # NOTE: Type YES in uppercase , then enter the desired passphrase
  
  }
  
  # Open the partition (root - can be any name)
  {
  
  cryptsetup luksOpen /dev/sda5 root

  }
  
  # Create a filesystem
  {
  
  mkfs.ext4 /dev/mapper/root
  
  }
  
  # Mount the newly created encrypted partition
  {
  
  mount /dev/mapper/root /mnt/
  
  }
  
  # Check the LUKS output for encrypted partitions
  {
  
  cryptsetup luksDump /dev/<drive>
  
  }
  
  # Add passphrases to an existing LUKS partition
  {
    
  cryptsetup luksAddKey /dev/<drive>

  }
  
  # Change an existing key
  {
  
  cryptsetup luksChangeKey /dev/<drive>
  
  }
  
  # fstab
  {
  
  # NOTE: Combine with /etc/crypttab and optionally create a key for auto mount to work
  /dev/mapper/<luks-name> /mnt ext4 defaults,auto 0 0
  
  }
  
  # Create Mappings for non Root Partitions [Add /etc/mykey to the LUKS partition to auto mount without entering passphrase]
  {
  
  n /etc/crypttab
  
  <LuksName>	</dev/disk/by-uuid/XXXXXXXX>	/etc/mykey	<noauto,nofail>
  
  }
  
  # Grub Root partition mapping, add the following to the kernel line -  the GRUB_CMDLINE_LINUX_DEFAULT=""
  {
  
  n /etc/default/grub
  
  GRUB_CMDLINE_LINUX_DEFAULT="cryptdevice=/dev/disk/by-uuid/xxxxxxxxxxx:<dev-mapper-name>"
  
  }
  
  # Edit Mkinitcpio [Only if LUKS is on Root] (encrypt before filesystems)
  {
   
  HOOKS="xxx xxx xxx xxx encrypt filesystems xxx xxx"

  }
  
  

  
}
