#!/bin/bash

# NOTE 1: 
#
# Encrypted LVM can be set up in 2 ways: LVM on LUKS, or LUKS on LVM.
# In a single-disk system, either is acceptable. However
# if you want to span your LVM across multiple drives in the future
# you must use LUKS on LVM


# NOTE2:
# 
# If using LVM + mdadm , make sure it is LVM on mdadm,
# not the other way around



  # Installation
{

 modprobe dm-mod

}


# DISKS = Physical volumes '/dev/sda1 /dev/sdb1 /dev/sdc1 /dev/md127'
DISKS='/dev/md0'

VG_NAME='C1'

LV_NAME='Brick1'




  # Create physical volumes
{

 sudo pvcreate "$DISKS"

 sudo pvdisplay
 #or (better)
 sudo pvs 

}

  # Create volume group
{

  sudo vgcreate "$VG_NAME" "$DISKS"

  sudo vgdisplay
  #or (better)
  sudo vgs 

}

  # Create logical volumes
{

  sudo lvcreate -l +100%FREE "$VG_NAME" -n "$LV_NAME"

  # or for specific size

  sudo lvcreate -L 10G "$VG_NAME" -n "$LV_NAME"


  sudo lvdisplay
  #or (better)
  sudo lvs 
}

  # Create a Filesystem
{

  sudo mkfs.xfs /dev/mapper/"$VG_NAME"-"$LV_NAME"

}


  # Remove Volume Group
{
	
  sudo vgremove "$VG_NAME"
	
}
	

# Grow LVM PV (after changing its size from e.g: mdadm)
{
  
  # NOTE only when the size of the disk itself has changed
  sudo pvresize "$DISKS"

}
  
  
  # Grow logical volume (can be done online)
{
  #NOTE: ( pvcreate /dev/xxx )  then,
  
  # Add new HDD to Pool
  
  sudo vgextend "$VG_NAME" "$DISKS"


  # Grow by specific size
  
  sudo lvextend -L 20G "$VG_NAME"/"$LV_NAME"
  
  # Grow by all available space
  
  sudo lvextend -l +100%FREE "$VG_NAME"/"$LV_NAME"

  # Then
  
  sudo resize2fs /dev/mapper/"$VG_NAME"-"$LV_NAME"

}

  # Shrink LV & remove partition from VG
{
  
  # Filesystem must be downsized more than the LV
  # 8500G is the new filesystem size of (Original-Media)

  sudo e2fsck -f /dev/mapper/"$VG_NAME"-"$LV_NAME"
  sudo resize2fs /dev/mapper/"$VG_NAME"-"$LV_NAME" 8500G
  sudo lvreduce /dev/mapper/"$VG_NAME"-"$LV_NAME" -L 8900G
  sudo resize2fs /dev/mapper/"$VG_NAME"-"$LV_NAME"
  sudo pvmove /dev/sdXX
  sudo vgreduce VG /dev/sdXX
  sudo pvremove /dev/sdXX

  # To fix the "No extents available to allocate" when trying to remove a PV
  # The filesystem must be downsized and then the LV must be downsized then pvmove

}

  # Find Failed HDD to remove
{
  
  p smartmontools

  # To find the serial number which is printed on the face of the HDD or by scanning the barcode

  sudo smartctl -i /dev/sdXX

}


  # Backup & Restore LVM Config
{
	# Backup
	
	sudo vgcfgbackup
		
		# The backup is found at /etc/lvm/backup/vg-name
	
	
	# Restore
	
	sudo vgcfgrestore -f <file>
	
}

  # Finalizing
{

  # Your logical volumes should now be located in [/dev/mapper/] and [/dev/YourVolumeGroupName]
  # If you cannot find them, use the next commands to make volume groups available

  sudo modprobe dm-mod
  sudo vgscan
  sudo vgchange -ay
  sudo systemctl enable lvm-monitoring

}


  # Final Note
  
 1: Add the "dm_mod" module to the "MODULES" list in "/etc/mkinitcpio.conf"
 2: Add the "mdadm_udev" & "lvm2" hooks to the "HOOKS" list in "/etc/mkinitcpio.conf" after udev
 3: mkinitcpio -p linux



#######################################################################

# Resources

https://wiki.archlinux.org/index.php/Lvm
